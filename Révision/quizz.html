<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Class - Navigateur Dynamique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Quiz Styles */
        .hypothesis-card { cursor: pointer; transition: all 0.2s; }
        .hypothesis-card:hover { border-color: #6366f1; background-color: #f5f3ff; }
        .hypothesis-card.selected { background-color: #e0e7ff; border-color: #4338ca; border-width: 2px; }
        .hypothesis-card.correct { background-color: #dcfce7 !important; border-color: #16a34a !important; }
        .hypothesis-card.wrong { background-color: #fee2e2 !important; border-color: #dc2626 !important; opacity: 0.8; }
        .hypothesis-card.missed { border-color: #16a34a !important; border-style: dashed !important; border-width: 2px; }

        /* Styles pour la Modale */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50; 
        }

        /* NOUVEAU : Style pour l'explication cach√©e qui appara√Æt */
        .explanation-reveal {
            animation: fadeInText 0.5s ease-in forwards;
        }
        @keyframes fadeInText { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6 text-slate-800">

    <div id="setup-screen" class="w-full max-w-2xl text-center fade-in">
        <h1 class="text-5xl font-extrabold text-slate-800 mb-6">üìö Master Class Maths</h1>
        <div class="bg-white p-10 rounded-3xl shadow-xl border-2 border-dashed border-slate-300 hover:border-indigo-500 transition group">
            <div class="text-6xl mb-4 group-hover:scale-110 transition transform">üìÇ</div>
            <h2 class="text-2xl font-bold mb-4 text-slate-700">O√π sont vos cours ?</h2>
            <p class="text-slate-500 mb-8">S√©lectionnez le dossier racine <strong>"Questions"</strong> contenant vos sous-dossiers (Pr√©pa, Centrale, etc.) et fichiers JSON.</p>
            
            <label class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full cursor-pointer shadow-lg transition transform hover:scale-105 inline-flex items-center gap-3">
                <span>S√©lectionner le dossier "Questions"</span>
                <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden" onchange="handleFolderSelect(event)">
            </label>
        </div>
    </div>

    <header id="app-header" class="hidden text-center mb-8 w-full max-w-4xl fade-in pt-10">
        <h1 onclick="goHome()" class="text-3xl font-extrabold text-indigo-700 cursor-pointer hover:text-indigo-900 transition">
            üéì Master Class
        </h1>
        <p id="path-display" class="text-slate-400 text-sm mt-1">Accueil</p>
    </header>

    <div id="cursus-menu" class="hidden w-full max-w-6xl grid grid-cols-1 md:grid-cols-3 gap-6 fade-in"></div>

    <div id="subject-menu" class="hidden w-full max-w-4xl fade-in">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="goHome()" class="bg-white p-2 rounded-full shadow hover:bg-slate-100 transition">‚Üê</button>
            <h2 id="cursus-title" class="text-3xl font-bold text-slate-800">Mati√®res</h2>
        </div>
        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="quiz-ui" class="hidden w-full max-w-4xl fade-in">
        <div class="flex justify-between items-center mb-6">
            <button onclick="goBackToSubjects()" class="text-slate-500 hover:text-slate-800 font-semibold flex items-center gap-2">
                <span>‚Üê Retour</span>
            </button>
            <div class="bg-white px-4 py-2 rounded-full shadow text-slate-700 font-bold">
                Score : <span id="current-score" class="text-indigo-600">0</span>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-6">
            <div id="theme-header" class="bg-slate-800 p-4 text-white font-bold text-lg flex justify-between items-center">
                <span id="quiz-title">Titre du Cours</span>
                <span id="progress-indicator" class="text-sm opacity-80">1 / ?</span>
            </div>
            
            <div class="p-8">
                <h2 id="thm-name" class="text-2xl font-bold text-slate-800 mb-4">Nom du Th√©or√®me</h2>
                
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 mb-6">
                    <p class="text-xs text-slate-500 uppercase font-bold mb-2 tracking-wider">√ânonc√©</p>
                    <div id="thm-statement" class="text-xl text-slate-900 font-serif leading-relaxed">...</div>
                </div>

                <p class="mb-4 text-slate-600 font-medium text-sm">
                    Cochez les hypoth√®ses <span class="text-red-500 font-bold">n√©cessaires</span> :
                </p>

                <div id="choices-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    </div>

                <div class="mt-8 flex flex-col items-center">
                    <div id="feedback-msg" class="hidden mb-4 text-lg font-bold"></div>
                    
                    <button id="btn-validate" onclick="validateAnswer()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:scale-105">
                        Valider
                    </button>
                    <button id="btn-next" onclick="nextQuestion()" class="hidden bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-12 rounded-full shadow-lg transition">
                        Suivant ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="end-screen" class="hidden w-full max-w-2xl text-center bg-white p-12 rounded-2xl shadow-2xl fade-in">
        <div class="text-6xl mb-6">üèÜ</div>
        <h2 class="text-3xl font-bold text-slate-800 mb-4">Termin√© !</h2>
        <p class="text-xl text-slate-600 mb-8">Score final : <span id="final-score" class="font-bold text-indigo-600"></span></p>
        <div class="flex justify-center gap-4">
            <button onclick="restartQuiz()" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-bold py-2 px-6 rounded transition">Rejouer</button>
            <button onclick="goBackToSubjects()" class="bg-slate-800 text-white hover:bg-slate-900 font-bold py-2 px-6 rounded transition">Menu Mati√®res</button>
        </div>
    </div>
    
    <div id="stats-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" onclick="closeStatsModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all p-8" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="stats-title" class="text-2xl font-bold text-slate-800">Statistiques</h3>
                <button onclick="closeStatsModal()" class="text-slate-400 hover:text-slate-800 text-2xl font-light">√ó</button>
            </div>
            <div class="mb-8">
                <h4 class="text-xl font-semibold mb-3 text-indigo-700">üìà √âvolution</h4>
                <div class="relative h-64 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <canvas id="scoreChart"></canvas>
                </div>
                <p id="no-data-msg" class="text-center text-slate-500 mt-4 hidden">Pas de donn√©es.</p>
            </div>
            <div class="mb-4">
                <h4 class="text-xl font-semibold mb-3 text-indigo-700">üìã Derniers scores</h4>
                <table class="min-w-full bg-white border border-slate-200 rounded-lg overflow-hidden">
                    <thead class="bg-slate-50">
                        <tr><th class="py-2 px-4 text-left text-sm font-semibold text-slate-600">Date</th><th class="py-2 px-4 text-right text-sm font-semibold text-slate-600">Score</th></tr>
                    </thead>
                    <tbody id="stats-history"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- √âTAT GLOBAL ---
        let fileStructure = {}; 
        let currentCursus = null;
        let currentQuizData = null;
        let currentQuizKey = null; 
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let maxScorePerQuiz = 0; 
        let scoreChartInstance = null;

        // --- 1. GESTION DES FICHIERS ---
        function handleFolderSelect(event) {
            const files = event.target.files;
            fileStructure = {}; 

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.name.toLowerCase().endsWith('.json')) continue;

                const relativePath = file.webkitRelativePath.replace(/\\/g, '/');
                const pathParts = relativePath.split('/');
                let folderName = pathParts.length >= 3 ? pathParts[1] : "Divers";
                
                if (!fileStructure[folderName]) fileStructure[folderName] = [];
                fileStructure[folderName].push({ file: file, key: `${folderName}/${file.name}` }); 
            }

            if (Object.keys(fileStructure).length === 0) {
                alert("Aucun fichier .json valide trouv√©.");
                return;
            }
            initCursusMenu();
        }

        // --- 2. MENUS ---
        function initCursusMenu() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.body.classList.remove('justify-center');
            document.getElementById('app-header').classList.remove('hidden');
            
            const menuContainer = document.getElementById('cursus-menu');
            menuContainer.innerHTML = '';
            const borderColors = ['border-blue-500', 'border-emerald-500', 'border-red-500', 'border-purple-500', 'border-orange-500'];
            let colorIdx = 0;

            for (const [folderName, files] of Object.entries(fileStructure)) {
                const colorClass = borderColors[colorIdx % borderColors.length];
                const card = document.createElement('div');
                card.className = `bg-white p-8 rounded-2xl shadow-lg border-t-8 ${colorClass} card-hover cursor-pointer text-center flex flex-col items-center justify-center min-h-[200px]`;
                card.onclick = () => showSubjects(folderName);
                card.innerHTML = `<div class="text-5xl mb-4">üìÅ</div><h2 class="text-2xl font-bold mb-2 text-slate-800">${folderName}</h2><p class="text-slate-400 text-sm">${files.length} mati√®re(s)</p>`;
                menuContainer.appendChild(card);
                colorIdx++;
            }
            goHome();
        }

        function goHome() {
            hideAll();
            document.getElementById('cursus-menu').classList.remove('hidden');
            document.getElementById('path-display').innerText = "Accueil";
        }

        function showSubjects(folderName) {
            currentCursus = folderName;
            const files = fileStructure[folderName];
            
            document.getElementById('cursus-title').innerText = folderName;
            document.getElementById('path-display').innerText = `Accueil > ${folderName}`;
            
            const grid = document.getElementById('subjects-grid');
            grid.innerHTML = "";

            files.forEach(item => {
                const file = item.file;
                const fileKey = item.key;
                const displayName = file.name.replace('.json', '');
                
                const stats = getStats(fileKey);
                const lastScore = stats.length > 0 ? stats[stats.length - 1].score : null;
                const maxTheoreticalScore = stats.length > 0 ? stats[stats.length - 1].maxScore : null;
                
                let scoreHtml = lastScore !== null ? `<span class="text-sm text-indigo-500 font-bold">${lastScore}/${maxTheoreticalScore}</span>` : '<span class="italic text-gray-400">Aucun</span>';

                const btn = document.createElement('div');
                btn.className = "bg-white border border-slate-200 p-6 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition flex flex-col justify-between group shadow-sm";
                btn.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3"><span class="text-2xl">üìÑ</span><span class="font-bold text-slate-700 group-hover:text-indigo-700 text-lg">${displayName}</span></div>
                        <div class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded group-hover:bg-white">Dernier : ${scoreHtml}</div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="loadFileContent('${fileKey}')" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-bold text-sm transition">Lancer le Quiz</button>
                        <button onclick="openStatsModal('${fileKey}', '${displayName}')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-bold text-sm transition" title="Voir les statistiques">üìä</button>
                    </div>
                `;
                grid.appendChild(btn);
            });
            hideAll();
            document.getElementById('subject-menu').classList.remove('hidden');
        }

        function loadFileContent(key) {
            // Retrouver le fichier via la cl√©
            let foundFile = null;
            for(const folder in fileStructure) {
                const found = fileStructure[folder].find(f => f.key === key);
                if(found) { foundFile = found.file; break; }
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    startQuiz(jsonContent, foundFile.name.replace('.json', ''), key);
                } catch (error) {
                    alert("Erreur JSON : " + error.message);
                }
            };
            reader.readAsText(foundFile);
        }

        function hideAll() {
            document.getElementById('cursus-menu').classList.add('hidden');
            document.getElementById('subject-menu').classList.add('hidden');
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
        }

        // --- 3. LOGIQUE QUIZ ---
        function startQuiz(data, defaultTitle, key) {
            currentQuizData = data;
            currentQuizKey = key;
            currentQuestions = [...data.questions].sort(() => 0.5 - Math.random());
            currentIndex = 0;
            score = 0;
            maxScorePerQuiz = currentQuestions.length * 10;

            const title = data.title || defaultTitle;
            document.getElementById('quiz-title').innerText = title;
            document.getElementById('path-display').innerText = `Accueil > ${currentCursus} > ${title}`;
            
            const header = document.getElementById('theme-header');
            header.style.backgroundColor = data.colorHex || '#1e293b';

            hideAll();
            document.getElementById('quiz-ui').classList.remove('hidden');
            loadQuestionUI();
        }

        function loadQuestionUI() {
            if (currentIndex >= currentQuestions.length) {
                endGame();
                return;
            }
            const q = currentQuestions[currentIndex];
            document.getElementById('progress-indicator').innerText = `${currentIndex + 1} / ${currentQuestions.length}`;
            document.getElementById('current-score').innerText = score;
            
            document.getElementById('thm-name').innerText = q.name;
            document.getElementById('thm-statement').innerHTML = q.statement;

            const grid = document.getElementById('choices-grid');
            grid.innerHTML = '';
            
            let opts = [];
            q.correct.forEach(t => opts.push({text: t, type: 'correct'}));
            q.distractors.forEach(t => opts.push({text: t, type: 'wrong'}));
            opts.sort(() => 0.5 - Math.random());

            opts.forEach(opt => {
                // --- NOUVEAU : LOGIQUE DE S√âPARATION PARENTH√àSES ---
                let mainText = opt.text;
                let explanation = "";
                
                // Regex : Cherche (texte) √† la toute fin de la chaine
                const match = mainText.match(/\s*\(([^)]+)\)$/); 
                if (match) {
                    explanation = match[0]; // (explication...)
                    mainText = mainText.replace(match[0], ''); // On enl√®ve l'explication du texte principal
                }
                // ---------------------------------------------------

                const el = document.createElement('div');
                el.className = "hypothesis-card bg-slate-50 border border-slate-200 rounded p-4 flex items-start select-none";
                el.dataset.type = opt.type;
                el.onclick = () => { if(document.getElementById('btn-next').classList.contains('hidden')) toggleSelection(el); };

                el.innerHTML = `
                    <div class="w-6 h-6 mt-1 border-2 border-slate-300 rounded mr-3 flex items-center justify-center box flex-shrink-0 bg-white">
                        <div class="w-3 h-3 bg-indigo-600 rounded-sm hidden check"></div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-slate-700 font-medium text-base leading-tight">${mainText}</span>
                        <span class="explanation-text hidden text-sm text-slate-500 italic mt-1 font-normal">${explanation}</span>
                    </div>
                `;
                grid.appendChild(el);
            });

            document.getElementById('btn-validate').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('feedback-msg').classList.add('hidden');
            
            if(window.MathJax) MathJax.typesetPromise();
        }

        function toggleSelection(el) {
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                el.querySelector('.check').classList.add('hidden');
                el.querySelector('.box').classList.remove('border-indigo-600');
            } else {
                el.classList.add('selected');
                el.querySelector('.check').classList.remove('hidden');
                el.querySelector('.box').classList.add('border-indigo-600');
            }
        }

        function validateAnswer() {
            const cards = document.querySelectorAll('.hypothesis-card');
            const q = currentQuestions[currentIndex];
            let mistakes = 0;
            let found = 0;

            cards.forEach(card => {
                const selected = card.classList.contains('selected');
                const isCorrect = card.dataset.type === 'correct';
                
                // --- NOUVEAU : AFFICHER LES EXPLICATIONS ---
                const explSpan = card.querySelector('.explanation-text');
                if(explSpan && explSpan.innerText.trim() !== "") {
                    explSpan.classList.remove('hidden');
                    explSpan.classList.add('explanation-reveal');
                }
                // ------------------------------------------
                
                card.classList.remove('selected');
                if (isCorrect) {
                    if (selected) { card.classList.add('correct'); found++; }
                    else { card.classList.add('missed'); mistakes++; }
                } else {
                    if (selected) { card.classList.add('wrong'); mistakes++; }
                    else { card.style.opacity = "0.5"; }
                }
            });

            const fb = document.getElementById('feedback-msg');
            fb.classList.remove('hidden');
            
            if (mistakes === 0 && found === q.correct.length) {
                fb.innerText = "Parfait !";
                fb.className = "mb-4 text-xl font-bold text-green-600";
                score += 10;
            } else {
                fb.innerText = "Correction :";
                fb.className = "mb-4 text-xl font-bold text-red-500";
            }
            
            document.getElementById('current-score').innerText = score;
            document.getElementById('btn-validate').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestionUI();
        }

        function endGame() {
            saveScore(currentQuizKey, score, maxScorePerQuiz);
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score} / ${maxScorePerQuiz}`;
        }

        function restartQuiz() {
            startQuiz(currentQuizData, document.getElementById('quiz-title').innerText, currentQuizKey);
        }

        function goBackToSubjects() {
            currentCursus ? showSubjects(currentCursus) : goHome();
        }

        // --- 4. STATISTIQUES ---
        function getStats(key) {
            const saved = localStorage.getItem(`quiz_stats_${key}`);
            return saved ? JSON.parse(saved) : [];
        }

        function saveScore(key, userScore, maxScore) {
            const stats = getStats(key);
            const now = new Date();
            const newEntry = {
                date: now.toLocaleDateString('fr-FR') + ' ' + now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                score: userScore,
                maxScore: maxScore,
                timestamp: now.getTime()
            };
            stats.push(newEntry);
            if (stats.length > 20) stats.shift();
            localStorage.setItem(`quiz_stats_${key}`, JSON.stringify(stats));
        }

        function openStatsModal(key, title) {
            const modal = document.getElementById('stats-modal');
            document.getElementById('stats-title').innerText = "Statistiques : " + title;
            modal.classList.remove('hidden');
            const stats = getStats(key);
            const historyBody = document.getElementById('stats-history');
            const noDataMsg = document.getElementById('no-data-msg');
            const canvas = document.getElementById('scoreChart');

            historyBody.innerHTML = '';
            if (stats.length === 0) {
                noDataMsg.classList.remove('hidden');
                canvas.classList.add('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                canvas.classList.remove('hidden');
                [...stats].reverse().forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-100 hover:bg-slate-50";
                    const pct = Math.round((entry.score / entry.maxScore) * 100);
                    let color = pct >= 80 ? 'text-green-600' : (pct >= 50 ? 'text-orange-500' : 'text-red-600');
                    tr.innerHTML = `<td class="py-2 px-4 text-sm text-slate-700">${entry.date}</td><td class="py-2 px-4 text-right font-bold ${color}">${entry.score}/${entry.maxScore} (${pct}%)</td>`;
                    historyBody.appendChild(tr);
                });
                renderChart(stats);
            }
        }

        function closeStatsModal(e) { document.getElementById('stats-modal').classList.add('hidden'); }

        function renderChart(stats) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (scoreChartInstance) scoreChartInstance.destroy();
            scoreChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stats.map((s, i) => `E${i + 1}`),
                    datasets: [{
                        label: 'R√©ussite (%)',
                        data: stats.map(s => (s.score / s.maxScore) * 100),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4338ca',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }
    </script>
</body>
</html>